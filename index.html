<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Kelengkapan Data Usulan (Live dari SITIA)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7f9; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; font-size: 0.9em; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .status-ok { color: #27ae60; font-weight: bold; }
        .status-no { color: #c0392b; font-weight: bold; }
        .balai-group { margin-bottom: 30px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #fdfdfd; }
        .balai-title { font-size: 1.2em; font-weight: bold; color: #2980b9; margin: 0 0 10px 0; }
        .filter-container { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        .filter-container label { font-weight: bold; }
        .filter-container select, .filter-container button { padding: 8px; border-radius: 4px; border: 1px solid #bdc3c7; }
        .filter-container button { background-color: #e74c3c; color: white; cursor: pointer; border-color: #c0392b; }
        .loader { text-align: center; padding: 50px; font-size: 1.5em; color: #7f8c8d; }
        .error-box { background-color: #ffebee; border: 1px solid #c0392b; color: #c0392b; padding: 15px; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Dashboard Monitoring Kelengkapan Usulan (Live Data)</h1>
        <div id="rekap-utama">
            <h2>Rekapitulasi Usulan Diterima per Balai</h2>
            <div id="rekap-balai-container" class="loader">Mengambil data dari server SITIA...</div>
        </div>
        <hr style="margin: 40px 0;">
        <div id="filter-usulan">
            <h2>Daftar Usulan Diterima (dengan Filter)</h2>
            <div class="filter-container">
                <label for="filter-direktorat">Direktorat:</label>
                <select id="filter-direktorat"><option value="">Semua Direktorat</option></select>
                <label for="filter-provinsi">Provinsi:</label>
                <select id="filter-provinsi"><option value="">Semua Provinsi</option></select>
                <button id="reset-filter">Reset Filter</button>
            </div>
            <table id="tabel-usulan">
                <thead>
                    <tr>
                        <th>No</th><th>Nama Paket</th><th>Balai</th><th>Provinsi</th><th>Direktorat</th><th>File Telaah</th><th>Berita Acara</th>
                    </tr>
                </thead>
                <tbody id="tabel-usulan-body">
                    <tr><td colspan="7" class="loader">Mengambil data dari server SITIA...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ===================================================================================
        // PERBAIKAN FINAL: MENGGUNAKAN PROXY ALTERNATIF (ALLORIGINS)
        // ===================================================================================
        const targetApiUrl = 'https://sitia.binamarga.pu.go.id/api/excel_service/usulan_inpres?thang=2025&api_key=QLJioD54aiMnSLLn806VpoW3w3gl9hur&type=json';
        const DATA_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetApiUrl)}`;


        document.addEventListener('DOMContentLoaded', fetchData);

        async function fetchData() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) { throw new Error(`Gagal mengambil data dari server: ${response.statusText}`); }
                
                // Proxy AllOrigins membungkus respons dalam 'contents'
                const data = await response.json();
                const allData = JSON.parse(data.contents);

                if (!allData) { throw new Error("Format data dari server tidak sesuai setelah melewati proxy."); }
                
                const dataDiterima = allData.filter(item => item.progres_kompetensi === 'Diterima');

                displayRekapPerBalai(dataDiterima);
                setupFilterableTable(dataDiterima);

            } catch (error) {
                console.error("Error:", error);
                const errorMessage = `
                    <div class="error-box">
                        <strong>Terjadi Kesalahan:</strong> Gagal memuat data dari server.
                        <p>Ini mungkin terjadi karena masalah CORS (keamanan browser) atau server sedang tidak dapat diakses. Silakan coba refresh halaman atau hubungi administrator.</p>
                        <p><small>Detail Error: ${error.message}</small></p>
                    </div>`;
                document.getElementById('rekap-balai-container').innerHTML = errorMessage;
                document.querySelector('#tabel-usulan-body').innerHTML = `<tr><td colspan="7" class="status-no">Gagal memuat data. Periksa console (F12) untuk detail.</td></tr>`;
            }
        }

        function displayRekapPerBalai(data) {
            const container = document.getElementById('rekap-balai-container');
            const groupedByBalai = data.reduce((acc, item) => {
                (acc[item.balai] = acc[item.balai] || []).push(item);
                return acc;
            }, {});

            if (Object.keys(groupedByBalai).length === 0) {
                container.innerHTML = "Tidak ada data usulan yang diterima."; return;
            }

            let html = '';
            const sortedBalaiKeys = Object.keys(groupedByBalai).sort();
            for (const balaiName of sortedBalaiKeys) {
                const usulanList = groupedByBalai[balaiName];
                html += `<div class="balai-group"><p class="balai-title">${balaiName}</p><table><thead><tr><th>Nama Paket</th><th>File Telaah</th><th>Berita Acara</th></tr></thead><tbody>`;
                usulanList.forEach(usulan => {
                    html += `<tr><td>${usulan.nama_paket}</td><td>${formatStatus(usulan.file_telaah_ada)}</td><td>${formatStatus(usulan.berita_acara_ada)}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
            container.innerHTML = html;
        }

        function setupFilterableTable(data) {
            const direktoratSelect = document.getElementById('filter-direktorat');
            const provinsiSelect = document.getElementById('filter-provinsi');
            const resetButton = document.getElementById('reset-filter');
            
            const uniqueDirektorat = [...new Set(data.map(item => item.direktorat_pengampu).filter(Boolean))].sort();
            const uniqueProvinsi = [...new Set(data.map(item => item.provinsi).filter(Boolean))].sort();

            uniqueDirektorat.forEach(dir => { direktoratSelect.innerHTML += `<option value="${dir}">${dir}</option>`; });
            uniqueProvinsi.forEach(prov => { provinsiSelect.innerHTML += `<option value="${prov}">${prov}</option>`; });

            const applyFilters = () => {
                const selectedDirektorat = direktoratSelect.value;
                const selectedProvinsi = provinsiSelect.value;
                const filteredData = data.filter(item => 
                    (!selectedDirektorat || item.direktorat_pengampu === selectedDirektorat) &&
                    (!selectedProvinsi || item.provinsi === selectedProvinsi)
                );
                renderTableBody(filteredData);
            };

            direktoratSelect.addEventListener('change', applyFilters);
            provinsiSelect.addEventListener('change', applyFilters);
            resetButton.addEventListener('click', () => {
                direktoratSelect.value = '';
                provinsiSelect.value = '';
                applyFilters();
            });

            renderTableBody(data);
        }
        
        function renderTableBody(data) {
            const tableBody = document.getElementById('tabel-usulan-body');
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Data tidak ditemukan.</td></tr>`; return;
            }
            let html = '';
            data.forEach(item => {
                html += `<tr><td>${item.no}</td><td>${item.nama_paket}</td><td>${item.balai}</td><td>${item.provinsi}</td><td>${item.direktorat_pengampu}</td><td>${formatStatus(item.file_telaah_ada)}</td><td>${formatStatus(item.berita_acara_ada)}</td></tr>`;
            });
            tableBody.innerHTML = html;
        }
        
        function formatStatus(statusText) {
            return (statusText === 'Ada') ? `<span class="status-ok">✔ Ada</span>` : `<span class="status-no">✖ Tidak Ada</span>`;
        }
    </script>
</body>
</html>
